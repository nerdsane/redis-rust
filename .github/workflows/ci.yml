name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# See HARNESS.md for the full verification loop and expected outputs.

jobs:
  # Layer 1: Unit tests (507 tests including 87 replication + CRDT DST)
  test:
    name: Unit Tests (Layer 1)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Unit tests (507 tests)
        run: cargo test --lib

      - name: All targets (including integration tests)
        run: cargo test --all-targets

  # Layer 2: Official Redis Tcl test suite
  tcl-compat:
    name: Tcl Compat (Layer 2)
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install Tcl
        run: sudo apt-get update && sudo apt-get install -y tcl

      - name: Build server (release)
        run: cargo build --bin redis-server-optimized --release

      # Run the two suites that fully pass.
      # string.tcl and multi.tcl crash on unimplemented commands (SETBIT, SWAPDB)
      # so they are excluded from required CI.
      - name: incr.tcl (28/28 expected)
        run: ./scripts/run-redis-compat.sh unit/type/incr

      - name: expire.tcl (all expected)
        run: ./scripts/run-redis-compat.sh unit/expire

  # Layer 3: Maelstrom linearizability (Jepsen/Knossos)
  maelstrom:
    name: Maelstrom (Layer 3)
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install gnuplot
        run: sudo apt-get update && sudo apt-get install -y gnuplot

      - name: Build Maelstrom binary
        run: cargo build --release --bin maelstrom-kv-replicated

      - name: Single-node linearizability
        run: |
          java -Djava.awt.headless=true \
            -jar maelstrom/maelstrom/lib/maelstrom.jar test -w lin-kv \
            --bin ./target/release/maelstrom-kv-replicated \
            --node-count 1 --time-limit 10 --concurrency 4

      - name: 3-node linearizability
        run: |
          java -Djava.awt.headless=true \
            -jar maelstrom/maelstrom/lib/maelstrom.jar test -w lin-kv \
            --bin ./target/release/maelstrom-kv-replicated \
            --node-count 3 --time-limit 20 --concurrency 6 --rate 10

      - name: 5-node stress
        run: |
          java -Djava.awt.headless=true \
            -jar maelstrom/maelstrom/lib/maelstrom.jar test -w lin-kv \
            --bin ./target/release/maelstrom-kv-replicated \
            --node-count 5 --time-limit 30 --concurrency 10 --rate 50

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maelstrom-results
          path: store/
          retention-days: 7

  # Compilation with feature flags
  features:
    name: Feature Flags
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install OpenSSL dev
        run: sudo apt-get update && sudo apt-get install -y libssl-dev

      - name: Default features
        run: cargo check --all-targets

      - name: TLS feature
        run: cargo check --features tls

      - name: ACL feature
        run: cargo check --features acl

      - name: All optimizations
        run: cargo check --features "opt-all"
