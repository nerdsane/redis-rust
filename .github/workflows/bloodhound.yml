# Bloodhound Deterministic Simulation Testing
#
# Runs continuous DST to find bugs in redis-rust under fault conditions.
# Tests safety properties (linearizability, durability) and liveness.

name: Bloodhound DST

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run every 6 hours for continuous bug hunting
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      seeds:
        description: 'Number of seeds to explore'
        required: false
        default: '1000'
      fault_mode:
        description: 'Fault injection mode'
        required: false
        default: 'moderate'
        type: choice
        options:
          - calm
          - moderate
          - chaos

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Build redis-rust for testing
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release

      - name: Build Docker image
        run: |
          docker build -t redis-rust:bloodhound -f docker/Dockerfile .
          docker save redis-rust:bloodhound | gzip > redis-rust-bloodhound.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target/release/redis-server-optimized
            target/release/server-persistent
            redis-rust-bloodhound.tar.gz
          retention-days: 1

  # Quick PR validation using built-in DST
  pr-dst:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run DST tests (10 seeds)
        run: |
          # Run the built-in DST tests with multiple seeds
          for seed in $(seq 0 9); do
            echo "=== Running DST with seed $seed ==="
            RUST_LOG=info cargo test --release dst -- --nocapture 2>&1 || {
              echo "::error::DST failed at seed $seed"
              exit 1
            }
          done
        timeout-minutes: 15

      - name: Run streaming DST
        run: cargo test --release streaming_dst --nocapture
        timeout-minutes: 10

      - name: Run consistency tests
        run: cargo test --release consistency --nocapture
        timeout-minutes: 10

  # Full DST exploration on main branch
  main-dst:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    strategy:
      fail-fast: false
      matrix:
        seed_range: ['0-25', '25-50', '50-75', '75-100']
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Parse seed range
        id: seeds
        run: |
          IFS='-' read -r START END <<< "${{ matrix.seed_range }}"
          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END" >> $GITHUB_OUTPUT

      - name: Run DST exploration
        run: |
          passed=0
          failed=0

          for seed in $(seq ${{ steps.seeds.outputs.start }} ${{ steps.seeds.outputs.end }}); do
            echo "=== Seed $seed ==="
            if SIMULATION_SEED=$seed cargo test --release dst -- --nocapture 2>&1; then
              passed=$((passed + 1))
            else
              failed=$((failed + 1))
              echo "::warning::Seed $seed failed"
            fi
          done

          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT

          # Create results JSON
          echo "{\"range\": \"${{ matrix.seed_range }}\", \"passed\": $passed, \"failed\": $failed}" > results-${{ matrix.seed_range }}.json

          # Only fail if there were actual failures
          if [ $failed -gt 0 ]; then
            echo "::error::$failed seeds failed"
            exit 1
          fi
        timeout-minutes: 60

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: dst-results-${{ matrix.seed_range }}
          path: results-${{ matrix.seed_range }}.json

  # Aggregate DST results
  aggregate-dst:
    runs-on: ubuntu-latest
    needs: main-dst
    if: always() && github.event_name == 'push'
    steps:
      - name: Download results
        uses: actions/download-artifact@v4
        with:
          pattern: dst-results-*
          merge-multiple: true

      - name: Aggregate
        run: |
          total_passed=0
          total_failed=0

          for f in results-*.json; do
            if [ -f "$f" ]; then
              passed=$(jq -r '.passed // 0' "$f")
              failed=$(jq -r '.failed // 0' "$f")
              total_passed=$((total_passed + passed))
              total_failed=$((total_failed + failed))
            fi
          done

          total=$((total_passed + total_failed))

          echo "## DST Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total seeds | $total |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $total_passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $total_failed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $total_failed -gt 0 ]; then
            echo "::error::$total_failed seeds failed out of $total"
            exit 1
          fi

          echo "All $total seeds passed!"

  # Bloodhound parallel exploration (using external bloodhound tool)
  bloodhound-parallel:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Load Docker image
        run: gunzip -c redis-rust-bloodhound.tar.gz | docker load

      - name: Install Bloodhound
        run: |
          cargo install --git https://github.com/nerdsane/bloodhound bloodhound || {
            echo "::warning::Could not install bloodhound, skipping parallel exploration"
            exit 0
          }

      - name: Run parallel exploration
        run: |
          cd bloodhound

          SEEDS="${{ github.event.inputs.seeds || '1000' }}"

          bloodhound parallel \
            --compose docker-compose.yml \
            --seeds $SEEDS \
            --workers 4 \
            --timeout-per-seed 120 \
            --format json \
            > ../bloodhound-results.json 2>&1 || true

          # Check results
          if [ -f ../bloodhound-results.json ]; then
            violations=$(jq -r '.violations | length' ../bloodhound-results.json 2>/dev/null || echo "0")
            seeds=$(jq -r '.total_seeds' ../bloodhound-results.json 2>/dev/null || echo "0")

            echo "## Bloodhound Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Seeds explored: $seeds" >> $GITHUB_STEP_SUMMARY
            echo "- Violations: $violations" >> $GITHUB_STEP_SUMMARY
          fi
        timeout-minutes: 120

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bloodhound-results-${{ github.run_number }}
          path: bloodhound-results.json
          retention-days: 30

  # Maelstrom linearizability tests (for distributed correctness)
  maelstrom:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Java (for Maelstrom)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Maelstrom
        run: |
          if [ ! -f maelstrom/maelstrom ]; then
            rm -rf maelstrom  # Remove partial extraction if any
            curl -L https://github.com/jepsen-io/maelstrom/releases/download/v0.2.3/maelstrom.tar.bz2 | tar xj
          fi

      - name: Build Maelstrom binary
        run: cargo build --release --bin maelstrom_kv_replicated

      - name: Run Maelstrom lin-kv test
        run: |
          ./maelstrom/maelstrom test -w lin-kv \
            --bin ./target/release/maelstrom_kv_replicated \
            --node-count 3 \
            --time-limit 60 \
            --rate 100 \
            --concurrency 10 \
            2>&1 | tee maelstrom-output.txt

          # Check for success
          if grep -q "Everything looks good" maelstrom-output.txt; then
            echo "Maelstrom linearizability test passed!"
          else
            echo "::error::Maelstrom linearizability test failed"
            exit 1
          fi
        timeout-minutes: 10

      - name: Upload Maelstrom results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maelstrom-results
          path: |
            store/
            maelstrom-output.txt
          retention-days: 7

  # Redis equivalence tests (differential testing)
  redis-equivalence:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Start Redis
        run: |
          docker run -d --name redis -p 6379:6379 redis:7-alpine
          sleep 2

      - name: Start redis-rust
        run: |
          cargo build --release --bin redis-server-optimized
          REDIS_PORT=3000 ./target/release/redis-server-optimized &
          sleep 2

      - name: Run equivalence tests
        run: cargo test --release redis_equivalence -- --ignored --nocapture
        timeout-minutes: 10

      - name: Cleanup
        if: always()
        run: |
          docker stop redis || true
          pkill redis-server-optimized || true
